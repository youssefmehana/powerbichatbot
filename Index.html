<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI Chatbot</title>

<style>
body { font-family: Arial; margin: 0; padding: 0; }
.chatbot-btn {
  position: fixed; bottom: 25px; right: 25px;
  background: #4e73df; color: white;
  width: 60px; height: 60px; border-radius: 50%;
  text-align: center; line-height: 60px; font-size: 30px;
  cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.chat-window {
  position: fixed; bottom: 100px; right: 25px;
  width: 320px; height: 420px; background: white;
  border-radius: 12px;
  display: none; flex-direction: column;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.header { background: #4e73df; color: white; padding: 10px; text-align: center; border-radius: 12px 12px 0 0; }
.messages { flex: 1; padding: 10px; overflow-y: auto; font-size: 14px; }
.input-box { padding: 10px; display: flex; gap: 5px; }
input { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
button { padding: 8px 14px; background: #4e73df; color: white; border: none; border-radius: 6px; cursor: pointer; }
</style>

</head>

<body>

<div class="chatbot-btn" onclick="toggleChat()">üí¨</div>

<div class="chat-window" id="chatWindow">
  <div class="header">AI Chatbot</div>
  <div class="messages" id="messages"></div>
  <div class="input-box">
    <input type="text" id="userInput" placeholder="Ask a question...">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
function toggleChat() {
  const win = document.getElementById("chatWindow");
  win.style.display = win.style.display === "flex" ? "none" : "flex";
}

function addMessage(text, sender) {
  const msgBox = document.getElementById("messages");
  const p = document.createElement("p");
  p.innerHTML = `<strong>${sender}:</strong> ${text}`;
  msgBox.appendChild(p);
  msgBox.scrollTop = msgBox.scrollHeight;
}

async function sendMessage() {
  const text = document.getElementById("userInput").value;
  if (!text) return;

  addMessage(text, "You");
  document.getElementById("userInput").value = "";

  try {
    const response = await fetch("https://dashboardchatbot.app.n8n.cloud/webhook/powerbi-groq-chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question: text })
    });

    // üîç Check if server returned JSON
    const contentType = response.headers.get("content-type");
    if (!contentType || !contentType.includes("application/json")) {
      const rawText = await response.text();
      addMessage("‚ö†Ô∏è Server did NOT return JSON.\nRaw response:\n" + rawText, "Bot");
      console.error("Raw server response:", rawText);
      return;
    }

    // ‚úÖ Parse JSON safely
    const data = await response.json();
    addMessage(data.answer || "No response from bot", "Bot");

  } catch (error) {
    console.error("Error:", error);
    addMessage("‚ö†Ô∏è Network error or invalid server response.", "Bot");
  }
}
</script>

</body>
</html>
